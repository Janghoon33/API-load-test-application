<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Load Test Service</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f7fa;
            color: #2d3748;
            height: 100vh;
            overflow: hidden;
        }

        /* Layout */
        .layout {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: #1a202c;
            color: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #2d3748;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #2d3748;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 700;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .nav-menu {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            padding: 0 20px;
            font-size: 11px;
            font-weight: 600;
            color: #a0aec0;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 20px;
            color: #cbd5e0;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .nav-item:hover {
            background: #2d3748;
            color: white;
        }

        .nav-item.active {
            background: #667eea;
            color: white;
        }

        .nav-icon {
            font-size: 18px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Top Bar */
        .top-bar {
            height: 60px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .page-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a202c;
        }

        .connection-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .connection-badge.connected {
            background: #d1fae5;
            color: #065f46;
        }

        .connection-badge.disconnected {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        /* Card */
        .card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-size: 15px;
            font-weight: 600;
            color: #1a202c;
        }

        .card-body {
            padding: 20px;
        }

        /* Form */
        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-size: 13px;
            font-weight: 500;
            color: #4a5568;
        }

        input, select {
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
            background: white;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 12px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-card.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .stat-card.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .stat-label {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
        }

        .stat-icon {
            font-size: 24px;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        /* Progress */
        .progress-section {
            margin-bottom: 24px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .progress-title {
            font-size: 14px;
            font-weight: 600;
            color: #1a202c;
        }

        .progress-percent {
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
        }

        .progress-bar-container {
            height: 32px;
            background: #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            padding: 0 12px;
            color: white;
            font-size: 13px;
            font-weight: 600;
        }

        /* Charts */
        .charts-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 2px;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 500;
            color: #718096;
            background: transparent;
            border: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        /* Log Terminal */
        .log-terminal {
            background: #1e293b;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            height: 300px;
            overflow-y: auto;
        }

        .log-line {
            padding: 4px 0;
            line-height: 1.6;
        }

        .log-line.info { color: #60a5fa; }
        .log-line.success { color: #34d399; }
        .log-line.error { color: #f87171; }
        .log-line.warning { color: #fbbf24; }

        /* Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.running {
            background: #fef3c7;
            color: #92400e;
        }

        .badge.completed {
            background: #d1fae5;
            color: #065f46;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 70px;
            }

            .nav-item span {
                display: none;
            }

            .logo span {
                display: none;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .charts-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="layout">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">‚ö°</div>
                <span>LoadTest</span>
            </div>
        </div>

        <div class="nav-menu">
            <div class="nav-section">
                <div class="nav-section-title">Main</div>
                <div class="nav-item active">
                    <span class="nav-icon">üéØ</span>
                    <span>Load Test</span>
                </div>
                <div class="nav-item">
                    <span class="nav-icon">üìä</span>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item">
                    <span class="nav-icon">üìÅ</span>
                    <span>History</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Settings</div>
                <div class="nav-item">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </div>
                <div class="nav-item">
                    <span class="nav-icon">üìñ</span>
                    <span>Docs</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="top-bar-left">
                <div class="page-title">API Load Test Service</div>
            </div>
            <div id="connectionStatus" class="connection-badge disconnected">
                <div class="status-dot"></div>
                <span>Disconnected</span>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Test Configuration Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üîß Test Configuration</div>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>API Endpoint</label>
                            <input type="text" id="apiUrl" value="https://jsonplaceholder.typicode.com/posts/1" placeholder="Enter API endpoint">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Thread Type</label>
                            <select id="threadType">
                                <option value="VIRTUAL">Virtual Threads</option>
                                <option value="PLATFORM">Platform Threads</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>HTTP Method</label>
                            <select id="httpMethod">
                                <option value="GET">GET</option>
                                <option value="POST">POST</option>
                                <option value="PUT">PUT</option>
                                <option value="DELETE">DELETE</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Virtual Threads</label>
                            <input type="number" id="virtualThreads" value="1000" min="1">
                        </div>

                        <div class="form-group">
                            <label>Requests per Thread</label>
                            <input type="number" id="requestsPerThread" value="10" min="1">
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" id="startBtn" onclick="startTest()">
                            <span>‚ñ∂Ô∏è</span>
                            <span>Run Test</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Real-time Monitoring -->
            <div id="monitoringSection" style="display: none;">
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-label">Progress</div>
                        <div class="stat-value" id="progressValue">0%</div>
                    </div>

                    <div class="stat-card success">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-label">Success Rate</div>
                        <div class="stat-value" id="successRate">0%</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">‚ö°</div>
                        <div class="stat-label">Current TPS</div>
                        <div class="stat-value" id="tpsValue">0</div>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="card">
                    <div class="card-body">
                        <div class="progress-section">
                            <div class="progress-header">
                                <div class="progress-title">
                                    <span id="statusBadge"></span>
                                    Test Progress
                                </div>
                                <div class="progress-percent" id="progressPercent">0%</div>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" id="progressBar" style="width: 0%">
                                    <span id="progressText">0 / 0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìà Performance Metrics</div>
                    </div>
                    <div class="card-body">
                        <div class="charts-container">
                            <div class="chart-wrapper">
                                <canvas id="tpsChart"></canvas>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logs -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìù Logs</div>
                </div>
                <div class="card-body">
                    <div class="log-terminal" id="logTerminal"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let stompClient = null;
    let currentTestId = null;
    let tpsChart = null;
    let statusChart = null;
    let tpsData = [];
    let timeLabels = [];

    // Initialize Charts
    function initCharts() {
        const tpsCtx = document.getElementById('tpsChart');
        const statusCtx = document.getElementById('statusChart');

        if (!tpsCtx || !statusCtx) return;

        // TPS Line Chart
        tpsChart = new Chart(tpsCtx.getContext('2d'), {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'TPS',
                    data: tpsData,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 3,
                    pointHoverRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: 'TPS Over Time',
                        font: { size: 14, weight: '600' }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { font: { size: 11 } },
                        grid: { color: '#f1f5f9' }
                    },
                    x: {
                        ticks: { font: { size: 11 } },
                        grid: { display: false }
                    }
                }
            }
        });

        // Status Doughnut Chart
        statusChart = new Chart(statusCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Success', 'Failed'],
                datasets: [{
                    data: [0, 0],
                    backgroundColor: ['#10b981', '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { font: { size: 12 }, padding: 15 }
                    },
                    title: {
                        display: true,
                        text: 'Success vs Failure',
                        font: { size: 14, weight: '600' }
                    }
                }
            }
        });
    }

    // WebSocket Connection
    function connect() {
        const socket = new SockJS('http://localhost:8080/ws');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect({}, function() {
            addLog('‚úì Connected to server', 'success');
            document.getElementById('connectionStatus').className = 'connection-badge connected';
            document.getElementById('connectionStatus').innerHTML = '<div class="status-dot"></div><span>Connected</span>';
            document.getElementById('startBtn').disabled = false;
        }, function() {
            addLog('‚úó Connection failed. Retrying...', 'error');
            setTimeout(connect, 3000);
        });
    }

    // Start Test
    async function startTest() {
        const config = {
            url: document.getElementById('apiUrl').value,
            threadType: document.getElementById('threadType').value,
            virtualThreads: parseInt(document.getElementById('virtualThreads').value),
            requestsPerThread: parseInt(document.getElementById('requestsPerThread').value),
            method: document.getElementById('httpMethod').value
        };

        document.getElementById('startBtn').disabled = true;
        document.getElementById('startBtn').innerHTML = '<span>‚è≥</span><span>Running...</span>';
        document.getElementById('monitoringSection').style.display = 'block';

        tpsData = [];
        timeLabels = [];
        if (tpsChart) tpsChart.destroy();
        if (statusChart) statusChart.destroy();
        initCharts();

        addLog(`‚Üí Starting load test with ${config.virtualThreads} threads`, 'info');

        try {
            const response = await fetch('http://localhost:8080/api/tests/execute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            });

            const result = await response.json();
            currentTestId = result.testId;

            addLog(`‚Üí Test ID: ${currentTestId}`, 'success');
            subscribeToMetrics(currentTestId);

        } catch (error) {
            addLog(`‚úó Test failed: ${error.message}`, 'error');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').innerHTML = '<span>‚ñ∂Ô∏è</span><span>Run Test</span>';
        }
    }

    function subscribeToMetrics(testId) {
        stompClient.subscribe('/topic/metrics/' + testId, function(message) {
            updateMetrics(JSON.parse(message.body));
        });

        stompClient.subscribe('/topic/test-complete/' + testId, function(message) {
            onTestComplete(JSON.parse(message.body));
        });
    }

    function updateMetrics(metric) {
        const progress = metric.progress.toFixed(1);
        const successRate = metric.completedRequests > 0
            ? ((metric.successCount / metric.completedRequests) * 100).toFixed(1)
            : 0;

        // Update stats
        document.getElementById('progressValue').textContent = progress + '%';
        document.getElementById('successRate').textContent = successRate + '%';
        document.getElementById('tpsValue').textContent = metric.currentTps.toFixed(0);

        // Update progress bar
        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('progressPercent').textContent = progress + '%';
        document.getElementById('progressText').textContent =
            `${metric.completedRequests.toLocaleString()} / ${metric.totalRequests.toLocaleString()}`;

        // Status badge
        document.getElementById('statusBadge').innerHTML =
            metric.status === 'RUNNING'
                ? '<span class="badge running">‚è≥ Running</span>'
                : '<span class="badge completed">‚úì Completed</span>';

        // Update charts
        const elapsed = (metric.elapsedTimeMs / 1000).toFixed(0);
        if (timeLabels.length === 0 || timeLabels[timeLabels.length - 1] !== elapsed + 's') {
            timeLabels.push(elapsed + 's');
            tpsData.push(metric.currentTps);

            if (timeLabels.length > 30) {
                timeLabels.shift();
                tpsData.shift();
            }

            if (tpsChart) tpsChart.update('none');
        }

        if (statusChart) {
            statusChart.data.datasets[0].data = [metric.successCount, metric.failCount];
            statusChart.update('none');
        }

        addLog(`${metric.completedRequests}/${metric.totalRequests} | ‚úì ${metric.successCount} | ‚úó ${metric.failCount} | ${metric.currentTps.toFixed(0)} TPS`, 'info');
    }

    function onTestComplete(result) {
        addLog(`‚úì Test completed successfully`, 'success');
        addLog(`‚Üí Total: ${result.totalRequests.toLocaleString()} | Success: ${result.successCount.toLocaleString()} | TPS: ${result.tps.toFixed(2)}`, 'success');

        document.getElementById('startBtn').disabled = false;
        document.getElementById('startBtn').innerHTML = '<span>‚ñ∂Ô∏è</span><span>Run Test</span>';
    }

    function addLog(message, type = 'info') {
        const terminal = document.getElementById('logTerminal');
        const time = new Date().toLocaleTimeString('ko-KR');
        const line = document.createElement('div');
        line.className = 'log-line ' + type;
        line.textContent = `[${time}] ${message}`;
        terminal.appendChild(line);
        terminal.scrollTop = terminal.scrollHeight;

        if (terminal.children.length > 100) {
            terminal.removeChild(terminal.firstChild);
        }
    }

    window.onload = function() {
        addLog('‚Üí Initializing API Load Test Service...', 'info');
        document.getElementById('startBtn').disabled = true;
        connect();
        initCharts();
    };
</script>
</body>
</html>