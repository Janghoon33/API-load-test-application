<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Load Test Service</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f7fa;
            color: #2d3748;
            height: 100vh;
            overflow: hidden;
        }

        .layout {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: #1a202c;
            color: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #2d3748;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #2d3748;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 700;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .nav-menu {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            padding: 0 20px;
            font-size: 11px;
            font-weight: 600;
            color: #a0aec0;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 20px;
            color: #cbd5e0;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .nav-item:hover {
            background: #2d3748;
            color: white;
        }

        .nav-item.active {
            background: #667eea;
            color: white;
        }

        .nav-icon {
            font-size: 18px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Top Bar */
        .top-bar {
            height: 60px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .page-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a202c;
        }

        .connection-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .connection-badge.connected {
            background: #d1fae5;
            color: #065f46;
        }

        .connection-badge.disconnected {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        /* Card */
        .card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-size: 15px;
            font-weight: 600;
            color: #1a202c;
        }

        .card-body {
            padding: 20px;
        }

        /* Form */
        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-size: 13px;
            font-weight: 500;
            color: #4a5568;
        }

        input, select {
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
            background: white;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border: 1px solid #e2e8f0;
            padding: 20px;
            border-radius: 12px;
            transition: all 0.2s;
        }

        .stat-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .stat-label {
            font-size: 13px;
            color: #718096;
            font-weight: 500;
        }

        .stat-icon {
            font-size: 24px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #1a202c;
        }

        .stat-change {
            font-size: 12px;
            color: #10b981;
            margin-top: 4px;
        }

        /* Progress */
        .progress-section {
            margin-bottom: 24px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .progress-title {
            font-size: 14px;
            font-weight: 600;
            color: #1a202c;
        }

        .progress-percent {
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
        }

        .progress-bar-container {
            height: 32px;
            background: #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            padding: 0 12px;
            color: white;
            font-size: 13px;
            font-weight: 600;
        }

        /* Charts */
        .charts-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8fafc;
            padding: 12px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
        }

        td {
            padding: 12px;
            font-size: 14px;
            border-bottom: 1px solid #e2e8f0;
        }

        tr:hover {
            background: #f8fafc;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge.virtual {
            background: #ddd6fe;
            color: #5b21b6;
        }

        .badge.platform {
            background: #e0e7ff;
            color: #3730a3;
        }

        /* Log Terminal */
        .log-terminal {
            background: #1e293b;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            height: 300px;
            overflow-y: auto;
        }

        .log-line {
            padding: 4px 0;
            line-height: 1.6;
        }

        .log-line.info { color: #60a5fa; }
        .log-line.success { color: #34d399; }
        .log-line.error { color: #f87171; }
        .log-line.warning { color: #fbbf24; }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2d3748;
        }

        .empty-state-text {
            font-size: 14px;
        }
    </style>
</head>
<body>
<div class="layout">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">‚ö°</div>
                <span>LoadTest</span>
            </div>
        </div>

        <div class="nav-menu">
            <div class="nav-section">
                <div class="nav-section-title">Main</div>
                <div class="nav-item" onclick="switchPage('loadtest')">
                    <span class="nav-icon">üéØ</span>
                    <span>Load Test</span>
                </div>
                <div class="nav-item" onclick="switchPage('dashboard')">
                    <span class="nav-icon">üìä</span>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" onclick="switchPage('history')">
                    <span class="nav-icon">üìÅ</span>
                    <span>History</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="page-title" id="pageTitle">API Load Test Service</div>
            <div id="connectionStatus" class="connection-badge disconnected">
                <div class="status-dot"></div>
                <span>Disconnected</span>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Load Test Page -->
            <div id="loadtestPage" class="page-section active">
                <!-- Test Configuration -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üîß Test Configuration</div>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>API Endpoint</label>
                                <input type="text" id="apiUrl" value="https://jsonplaceholder.typicode.com/posts/1" placeholder="Enter API endpoint">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Thread Type</label>
                                <select id="threadType">
                                    <option value="VIRTUAL">Virtual Threads</option>
                                    <option value="PLATFORM">Platform Threads</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>HTTP Method</label>
                                <select id="httpMethod">
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                    <option value="PUT">PUT</option>
                                    <option value="DELETE">DELETE</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Virtual Threads</label>
                                <input type="number" id="virtualThreads" value="1000" min="1">
                            </div>

                            <div class="form-group">
                                <label>Requests per Thread</label>
                                <input type="number" id="requestsPerThread" value="10" min="1">
                            </div>
                        </div>

                        <button class="btn btn-primary" id="startBtn" onclick="startTest()">
                            <span>‚ñ∂Ô∏è</span>
                            <span>Run Test</span>
                        </button>
                    </div>
                </div>

                <!-- Monitoring -->
                <div id="monitoringSection" style="display: none;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">Progress</span>
                                <span class="stat-icon">üìà</span>
                            </div>
                            <div class="stat-value" id="progressValue">0%</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">Success</span>
                                <span class="stat-icon">‚úÖ</span>
                            </div>
                            <div class="stat-value" id="successValue">0</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">Failed</span>
                                <span class="stat-icon">‚ùå</span>
                            </div>
                            <div class="stat-value" id="failedValue">0</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">Current TPS</span>
                                <span class="stat-icon">‚ö°</span>
                            </div>
                            <div class="stat-value" id="tpsValue">0</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="progress-section">
                                <div class="progress-header">
                                    <div class="progress-title">
                                        <span id="statusBadge"></span>
                                    </div>
                                    <div class="progress-percent" id="progressPercent">0%</div>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill" id="progressBar" style="width: 0%">
                                        <span id="progressText">0 / 0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìà Performance Metrics</div>
                        </div>
                        <div class="card-body">
                            <div class="charts-container">
                                <div class="chart-wrapper">
                                    <canvas id="tpsChart"></canvas>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="statusChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìù Logs</div>
                    </div>
                    <div class="card-body">
                        <div class="log-terminal" id="logTerminal"></div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Page -->
            <div id="dashboardPage" class="page-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-label">Total Tests</span>
                            <span class="stat-icon">üéØ</span>
                        </div>
                        <div class="stat-value" id="dashTotalTests">0</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-label">Total Requests</span>
                            <span class="stat-icon">üì¶</span>
                        </div>
                        <div class="stat-value" id="dashTotalRequests">0</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-label">Avg TPS</span>
                            <span class="stat-icon">‚ö°</span>
                        </div>
                        <div class="stat-value" id="dashAvgTps">0</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-label">Success Rate</span>
                            <span class="stat-icon">‚úÖ</span>
                        </div>
                        <div class="stat-value" id="dashSuccessRate">0%</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìä Recent Tests</div>
                    </div>
                    <div class="card-body">
                        <div id="recentTestsContainer"></div>
                    </div>
                </div>
            </div>

            <!-- History Page -->
            <div id="historyPage" class="page-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìÅ Test History</div>
                    </div>
                    <div class="card-body">
                        <div class="table-container" id="historyTableContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let stompClient = null;
    let currentTestId = null;
    let currentPage = 'loadtest';
    let tpsChart = null;
    let statusChart = null;
    let tpsData = [];
    let errorChart = null;
    let timeLabels = [];

    // Page Switching
    function switchPage(page) {
        currentPage = page;

        document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

        document.getElementById(page + 'Page').classList.add('active');
        event.currentTarget.classList.add('active');

        const titles = {
            'loadtest': 'API Load Test Service',
            'dashboard': 'Dashboard',
            'history': 'Test History'
        };
        document.getElementById('pageTitle').textContent = titles[page];

        if (page === 'dashboard') {
            loadDashboard();
        } else if (page === 'history') {
            loadHistory();
        }
    }

    // Load Dashboard
    async function loadDashboard() {
        try {
            const response = await fetch('http://localhost:8080/api/stats/summary');
            const data = await response.json();

            document.getElementById('dashTotalTests').textContent = data.totalTests.toLocaleString();
            document.getElementById('dashTotalRequests').textContent = data.totalRequests.toLocaleString();
            document.getElementById('dashAvgTps').textContent = data.avgTps.toFixed(1);
            document.getElementById('dashSuccessRate').textContent = data.successRate.toFixed(1) + '%';

            const container = document.getElementById('recentTestsContainer');
            if (data.recentTests.length === 0) {
                container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <div class="empty-state-title">No tests yet</div>
                            <div class="empty-state-text">Run your first load test to see statistics here</div>
                        </div>
                    `;
            } else {
                container.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Type</th>
                                    <th>Requests</th>
                                    <th>Success</th>
                                    <th>TPS</th>
                                    <th>Date</th>
                                </tr>
                                </thead>
                            <tbody>
                                ${data.recentTests.map(test => `
                                    <tr>
                                        <td><strong>#${test.executionId}</strong></td>
                                        <td><span class="badge ${test.threadType.toLowerCase()}">${test.threadType}</span></td>
                                        <td>${test.totalRequests.toLocaleString()}</td>
                                        <td><span class="badge success">${test.successCount.toLocaleString()}</span></td>
                                        <td><strong>${test.tps.toFixed(2)}</strong></td>
                                        <td>${new Date(test.startedAt).toLocaleString('ko-KR')}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
            }
        } catch (error) {
            console.error('Failed to load dashboard:', error);
            addLog('‚úó Failed to load dashboard data', 'error');
        }
    }

    // Load History
    async function loadHistory() {
        try {
            const response = await fetch('http://localhost:8080/api/tests/results');
            const tests = await response.json();

            const container = document.getElementById('historyTableContainer');
            if (tests.length === 0) {
                container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìÅ</div>
                            <div class="empty-state-title">No test history</div>
                            <div class="empty-state-text">Your test results will appear here</div>
                        </div>
                    `;
            } else {
                container.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Thread Type</th>
                                    <th>Threads</th>
                                    <th>Total Requests</th>
                                    <th>Success</th>
                                    <th>Failed</th>
                                    <th>TPS</th>
                                    <th>Avg Response</th>
                                    <th>Duration</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tests.map(test => `
                                    <tr>
                                        <td><strong>#${test.executionId}</strong></td>
                                        <td><span class="badge ${test.threadType.toLowerCase()}">${test.threadType}</span></td>
                                        <td>${test.totalRequests / test.requestsPerThread || '-'}</td>
                                        <td>${test.totalRequests.toLocaleString()}</td>
                                        <td><span class="badge success">${test.successCount.toLocaleString()}</span></td>
                                        <td><span class="badge ${test.failCount > 0 ? 'warning' : 'success'}">${test.failCount}</span></td>
                                        <td><strong>${test.tps.toFixed(2)}</strong></td>
                                        <td>${test.avgResponseTimeMs}ms</td>
                                        <td>${(test.totalDurationMs / 1000).toFixed(1)}s</td>
                                        <td>${new Date(test.startedAt).toLocaleString('ko-KR', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
            }
        } catch (error) {
            console.error('Failed to load history:', error);
            addLog('‚úó Failed to load history data', 'error');
        }
    }

    // Initialize Charts
    function initCharts() {
        const tpsCtx = document.getElementById('tpsChart');
        const statusCtx = document.getElementById('statusChart');

        if (!tpsCtx || !statusCtx) return;

        if (tpsChart) tpsChart.destroy();
        if (statusChart) statusChart.destroy();

        tpsChart = new Chart(tpsCtx.getContext('2d'), {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'TPS',
                    data: tpsData,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 3,
                    pointHoverRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: 'TPS Over Time',
                        font: { size: 14, weight: '600' }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { font: { size: 11 } },
                        grid: { color: '#f1f5f9' }
                    },
                    x: {
                        ticks: { font: { size: 11 } },
                        grid: { display: false }
                    }
                }
            }
        });

        statusChart = new Chart(statusCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Success', 'Failed'],
                datasets: [{
                    data: [0, 0],
                    backgroundColor: ['#10b981', '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { font: { size: 12 }, padding: 15 }
                    },
                    title: {
                        display: true,
                        text: 'Success vs Failure',
                        font: { size: 14, weight: '600' }
                    }
                }
            }
        });
    }

    // WebSocket Connection
    function connect() {
        const socket = new SockJS('http://localhost:8080/ws');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect({}, function() {
            addLog('‚úì Connected to server', 'success');
            document.getElementById('connectionStatus').className = 'connection-badge connected';
            document.getElementById('connectionStatus').innerHTML = '<div class="status-dot"></div><span>Connected</span>';
            document.getElementById('startBtn').disabled = false;
        }, function() {
            addLog('‚úó Connection failed. Retrying...', 'error');
            setTimeout(connect, 3000);
        });
    }

    // Start Test
    async function startTest() {
        const config = {
            url: document.getElementById('apiUrl').value,
            threadType: document.getElementById('threadType').value,
            virtualThreads: parseInt(document.getElementById('virtualThreads').value),
            requestsPerThread: parseInt(document.getElementById('requestsPerThread').value),
            method: document.getElementById('httpMethod').value
        };

        document.getElementById('startBtn').disabled = true;
        document.getElementById('startBtn').innerHTML = '<span>‚è≥</span><span>Running...</span>';
        document.getElementById('monitoringSection').style.display = 'block';

        // ‚úÖ Í∏∞Ï°¥ ÏóêÎü¨ Ï∞®Ìä∏ Ï†úÍ±∞
        const existingErrorChart = document.getElementById('errorChartCard');
        if (existingErrorChart) {
            existingErrorChart.remove();
        }

        tpsData = [];
        timeLabels = [];
        initCharts();

        addLog(`‚Üí Starting test: ${config.virtualThreads} threads √ó ${config.requestsPerThread} requests`, 'info');

        try {
            const response = await fetch('http://localhost:8080/api/tests/execute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            });

            const result = await response.json();
            currentTestId = result.testId;

            addLog(`‚Üí Test ID: ${currentTestId}`, 'success');
            subscribeToMetrics(currentTestId);

        } catch (error) {
            addLog(`‚úó Failed: ${error.message}`, 'error');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').innerHTML = '<span>‚ñ∂Ô∏è</span><span>Run Test</span>';
        }
    }

    function subscribeToMetrics(testId) {
        stompClient.subscribe('/topic/metrics/' + testId, function(message) {
            updateMetrics(JSON.parse(message.body));
        });

        stompClient.subscribe('/topic/test-complete/' + testId, function(message) {
            onTestComplete(JSON.parse(message.body));
        });
    }

    function updateMetrics(metric) {
        const progress = metric.progress.toFixed(1);

        document.getElementById('progressValue').textContent = progress + '%';
        document.getElementById('successValue').textContent = metric.successCount.toLocaleString();
        document.getElementById('failedValue').textContent = metric.failCount.toLocaleString();
        document.getElementById('tpsValue').textContent = metric.currentTps.toFixed(0);

        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('progressPercent').textContent = progress + '%';
        document.getElementById('progressText').textContent =
            `${metric.completedRequests.toLocaleString()} / ${metric.totalRequests.toLocaleString()}`;

        document.getElementById('statusBadge').innerHTML =
            metric.status === 'RUNNING'
                ? '<span class="badge warning">‚è≥ Running</span>'
                : '<span class="badge success">‚úì Completed</span>';

        const elapsed = (metric.elapsedTimeMs / 1000).toFixed(0);
        if (timeLabels.length === 0 || timeLabels[timeLabels.length - 1] !== elapsed + 's') {
            timeLabels.push(elapsed + 's');
            tpsData.push(metric.currentTps);

            if (timeLabels.length > 30) {
                timeLabels.shift();
                tpsData.shift();
            }

            if (tpsChart) tpsChart.update('none');
        }

        if (statusChart) {
            statusChart.data.datasets[0].data = [metric.successCount, metric.failCount];
            statusChart.update('none');
        }

        addLog(`${metric.completedRequests}/${metric.totalRequests} | ${metric.currentTps.toFixed(0)} TPS`, 'info');
    }

    function onTestComplete(result) {
        addLog(`‚úì Completed: ${result.totalRequests.toLocaleString()} requests | TPS: ${result.tps.toFixed(2)}`, 'success');
        addLog(`  ‚îú‚îÄ Success: ${result.successCount.toLocaleString()} (${result.successRate.toFixed(1)}%)`, 'success');
        addLog(`  ‚îî‚îÄ Failed: ${result.failCount.toLocaleString()}`, result.failCount > 0 ? 'error' : 'success');

        // ‚úÖ ÏóêÎü¨Í∞Ä ÏûàÏúºÎ©¥ breakdown ÌëúÏãú
        if (result.failCount > 0 && result.errorBreakdown) {
            showErrorBreakdown(result.errorBreakdown);

            // Î°úÍ∑∏ÏóêÎèÑ ÏÉÅÏÑ∏ Ï∂úÎ†•
            addLog('', 'info');
            addLog('üìä Error Breakdown:', 'warning');
            Object.entries(result.errorBreakdown).forEach(([type, count]) => {
                const percentage = ((count / result.failCount) * 100).toFixed(1);
                addLog(`  ‚îú‚îÄ ${type}: ${count}Í±¥ (${percentage}%)`, 'error');
            });
        }

        document.getElementById('startBtn').disabled = false;
        document.getElementById('startBtn').innerHTML = '<span>‚ñ∂Ô∏è</span><span>Run Test</span>';
    }

    function addLog(message, type = 'info') {
        const terminal = document.getElementById('logTerminal');
        const time = new Date().toLocaleTimeString('ko-KR');
        const line = document.createElement('div');
        line.className = 'log-line ' + type;
        line.textContent = `[${time}] ${message}`;
        terminal.appendChild(line);
        terminal.scrollTop = terminal.scrollHeight;

        if (terminal.children.length > 100) {
            terminal.removeChild(terminal.firstChild);
        }
    }

    window.onload = function() {
        addLog('‚Üí Initializing API Load Test Service...', 'info');
        document.getElementById('startBtn').disabled = true;
        document.querySelectorAll('.nav-item')[0].classList.add('active');
        connect();
        initCharts();
    };

    function showErrorBreakdown(errorBreakdown) {
        if (!errorBreakdown || Object.keys(errorBreakdown).length === 0) {
            return;
        }

        // Í∏∞Ï°¥ ÏóêÎü¨ Ï∞®Ìä∏ Ï†úÍ±∞
        const existingErrorChart = document.getElementById('errorChartCard');
        if (existingErrorChart) {
            existingErrorChart.remove();
        }

        // ÏóêÎü¨ Î†àÏù¥Î∏î ÌïúÍ∏ÄÌôî
        const errorLabels = Object.keys(errorBreakdown);
        const errorCounts = Object.values(errorBreakdown);

        const errorDescriptions = {
            'TIMEOUT': '‚è±Ô∏è Timeout',
            'CONNECTION_FAILED': 'üîå Connection Failed',
            'CLIENT_ERROR_400': '‚ùå 400 Bad Request',
            'CLIENT_ERROR_401': 'üîí 401 Unauthorized',
            'CLIENT_ERROR_403': 'üö´ 403 Forbidden',
            'CLIENT_ERROR_404': '‚ùì 404 Not Found',
            'CLIENT_ERROR_429': 'üö¶ 429 Too Many Requests',
            'SERVER_ERROR_500': 'üí• 500 Internal Server Error',
            'SERVER_ERROR_502': 'üåê 502 Bad Gateway',
            'SERVER_ERROR_503': '‚ö†Ô∏è 503 Service Unavailable',
            'SERVER_ERROR_504': '‚è∞ 504 Gateway Timeout',
            'UNKNOWN': '‚ùì Unknown Error'
        };

        const translatedLabels = errorLabels.map(label => {
            return errorDescriptions[label] || label;
        });

        // ÏóêÎü¨ Ï∞®Ìä∏ HTML ÏÉùÏÑ±
        const errorChartHtml = `
        <div class="card" id="errorChartCard">
            <div class="card-header">
                <div class="card-title">‚ùå Error Breakdown</div>
            </div>
            <div class="card-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start;">
                    <!-- Ï∞®Ìä∏ ÏòÅÏó≠ -->
                    <div style="height: 250px;">
                        <canvas id="errorChart"></canvas>
                    </div>

                    <!-- ÌÖåÏù¥Î∏î ÏòÅÏó≠ -->
                    <div>
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Error Type</th>
                                    <th style="text-align: right;">Count</th>
                                    <th style="text-align: right;">Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${errorLabels.map((label, idx) => {
                const percentage = ((errorCounts[idx] / errorCounts.reduce((a, b) => a + b, 0)) * 100).toFixed(1);
                return `
                                        <tr>
                                            <td>${translatedLabels[idx]}</td>
                                            <td style="text-align: right;"><strong>${errorCounts[idx].toLocaleString()}</strong></td>
                                            <td style="text-align: right;"><span class="badge warning">${percentage}%</span></td>
                                        </tr>
                                    `;
            }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `;

        // Î™®ÎãàÌÑ∞ÎßÅ ÏÑπÏÖò ÎÅùÏóê Ï∂îÍ∞Ä
        document.getElementById('monitoringSection').insertAdjacentHTML('beforeend', errorChartHtml);

        // Ï∞®Ìä∏ ÏÉùÏÑ±
        const errorCtx = document.getElementById('errorChart').getContext('2d');
        errorChart = new Chart(errorCtx, {
            type: 'bar',
            data: {
                labels: translatedLabels,
                datasets: [{
                    label: 'Error Count',
                    data: errorCounts,
                    backgroundColor: [
                        '#ef4444',
                        '#f97316',
                        '#f59e0b',
                        '#eab308',
                        '#84cc16',
                        '#22c55e',
                        '#10b981',
                        '#14b8a6'
                    ],
                    borderWidth: 0,
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: 'Error Distribution',
                        font: { size: 14, weight: '600' }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            font: { size: 11 }
                        },
                        grid: { color: '#f1f5f9' }
                    },
                    x: {
                        ticks: { font: { size: 11 } },
                        grid: { display: false }
                    }
                }
            }
        });
    }

</script>
</body>
</html>